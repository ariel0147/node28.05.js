<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="index.css">
</head>
<body>
 <h1>רשימת משימות</h1>
 <div>
     <input type="hidden" id="id" >
<label for="txt">הכנס משימה</label>
     <br>
     <br>
     <br>
     <textarea id="txt" maxlength="50"></textarea>
     <br>
     <br>
     <button id="s" onclick="chekvalue()">send</button>
 </div>
 <br>
 <br>
 <br>
 <input id="searc" placeholder="searc..." oninput="search()">
 <br>
 <br>
 <br>
 <br>
 <br>

 <table border="1" id="Table-list">
     <tr>
     <th> id</th>
     <th> text</th>
         <th>בוצע</th>
      <th> edit</th>
         <th> delete</th>
     </tr>


 </table>
<script>
    let data = [] ;


    async function getdata(){
        let response = await fetch('/L');
        data = await response.json();
        console.log(data);
        createTable(data);
    }
    getdata();


    function createTable(data){
        let txt = "";

        for(obj of data){
            if (obj){
                let rowclass = obj.stay ? "rowclass" : "";
                let check = obj.stay ? "checked" : "";
                txt += "<tr class= ${rowclass}>";
                // txt += `<td>${obj.id}</td>`;
                txt += `<td>${obj.text}</td>`;

                txt += `<td><input type="checkbox" ${obj.stay ? "checked" : ""} onchange="toggleStay(${obj.id}, this.checked)"></td>`;
                txt += `<td><button id="e" onclick="edittask(${obj.id})">✏️</button></td>`;
                txt += `<td><button id="d" onclick=deletetask(${obj.id})>🗑️</button></td>`;
                txt += `</tr>`;
            }
    }
        document.getElementById("Table-list").innerHTML = txt
    }

async function addtask(){

        try {
            let txt = document.getElementById("txt").value;
            let response = await fetch('/L', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({txt})


            })

            if (response.status == 201){
                alert("נוסף בהצלחה")
            }

            getdata();
            document.getElementById("txt").value = "";
        }catch(err){
           alert(err)
       }

}

    async function deletetask(id){
        try {

            let response = await fetch(`/L${id}`,{
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({})

            })
            if (response.ok){

                alert("נמחק בהצלחה")
                getdata();
            }

        }catch(err){
            alert(err)
        }

    }

    async function edittask(id){
        try {

            let response = await fetch(`/L${id}`,{
                method: 'get',

            })
            let data = await response.json();
            // console.log(data.text);

               document.getElementById("id").value = data.id;
               document.getElementById("txt").value = data.text;
        }catch(err){
            alert(err)
        }

    }

    async function updatatask(id){
        console.log(id)
        try {
            let txt = document.getElementById("txt").value;
            let response = await fetch(`/L/${id}`,{
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({txt})

            })

            if (response.ok){

                alert("נערך בהצלחה")
                getdata();
            }

            document.getElementById("txt").value = "";
            document.getElementById("id").value = ""


        }catch(err){
            alert(err)
        }

    }


     function chekvalue(){
     let id = document.getElementById("id").value;
     if (id){
         updatatask(id)
     }
     else {addtask()}
    }

    async function toggleStay(id, checked) {
        try {
            let response = await fetch(`/L/${id}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ stay: checked })
            });

            if (!response.ok) {
                alert("שגיאה בעדכון סטטוס");
            } else {
                console.log("עודכן בהצלחה");
            }
        } catch (err) {
            alert(err);
        }
    }

function search(){

        let val = document.getElementById("searc").value;
        let sorted =  data.filter(obj => obj && obj.text.includes(val))
        if (sorted){
            createTable(sorted)
        }
        else {
            createTable(data);
        }
}



</script>
</body>
</html>
